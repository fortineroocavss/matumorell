<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>matumorell - Kick callback</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{background:#0b0b0b;color:#fff;font-family:Montserrat, sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:2rem}
    .card{max-width:900px;width:100%;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);padding:2rem;border-radius:12px}
    pre{white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,0.4);padding:1rem;border-radius:8px;color:#ddd}
  </style>
</head>
<body>
  <div class="card">
    <h2>Procesando autenticación con Kick...</h2>
    <div id="status">Por favor espera...</div>
    <h3 style="margin-top:1rem;">Resultado:</h3>
    <pre id="out">Esperando respuesta...</pre>
    <p style="margin-top:1rem;opacity:0.9;">Si ves un error, lo veremos aquí para depurar.</p>
  </div>

  <script>
    (async () => {
      const out = document.getElementById('out');
      const status = document.getElementById('status');
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');

      if (!code) {
        status.innerText = 'No se recibió "code" en la URL.';
        out.textContent = window.location.search;
        return;
      }

      status.innerText = 'Intercambiando código mediante backend...';

      // IMPORTANTE: reemplaza esta URL por la que Vercel te devuelva tras el deploy:
      // por ejemplo: 'https://mi-proyecto.vercel.app/api/token'
      const VERCEL_API = 'https://matumorell.vercel.app/api/token';

      const redirect_uri = 'https://fortineroocavss.github.io/matumorell/callback.html';

      try {
        const r = await fetch(VERCEL_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, redirect_uri })
        });

        const text = await r.text();
        status.innerText = `Intercambio: ${r.status}`;
        out.textContent = text;

        if (r.ok) {
          try {
            const token = JSON.parse(text);
            sessionStorage.setItem('kick_token', JSON.stringify(token));
          } catch (e) {
            // respuesta no JSON (ok para debug)
          }
        }
      } catch (err) {
        status.innerText = 'Error en la petición al servidor';
        out.textContent = String(err);
      }
    })();
  </script>
</body>
</html>
